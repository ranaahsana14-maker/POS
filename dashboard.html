<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; padding: 0;
      background: url('https://images.unsplash.com/photo-1647427017067-8f33ccbae493?q=80&w=1170&auto=format&fit=crop') no-repeat center center fixed; background-size: cover; }
    .container { width: 90%; max-width: 1100px; margin: 40px auto; padding: 30px; background: rgba(255, 255, 255, 0.1); border-radius: 20px; backdrop-filter: blur(12px); color: #fff; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 20px; }
    .search-bar { flex: 1; position: relative; }
    .search-bar input { width: 100%; padding: 12px 15px; border: none; border-radius: 10px; font-size: 16px; outline: none; }
    .suggestions { position: absolute; top: 110%; left: 0; right: 0; background: #fff; color: #000; border-radius: 8px; z-index: 5; max-height: 200px; overflow-y: auto; }
    .suggestions div { padding: 10px; cursor: pointer; } .suggestions div:hover { background-color: #eee; }
    .btn { padding: 12px 20px; border: none; font-weight: bold; border-radius: 10px; cursor: pointer; text-decoration: none; text-align: center; }
    .logout-btn { background: #ff4b2b; color: white; height: 45px; }
    .black-btn { background: rgb(59, 59, 61); color: white; flex: 1; }
    .green-btn { background: rgb(0, 206, 0); color: white; flex: 1; }
    .buttons { display: flex; gap: 10px; margin-top: 30px; }
    .product-list { margin-top: 30px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 20px; }
    .product-item { display: flex; flex-direction: column; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
    .product-item > .top-row { display: flex; justify-content: space-between; align-items: center; }
    .product-name { font-weight: 600; font-size: 18px; }
    .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
    .qty-controls button { padding: 5px 10px; background: #fff; border: none; border-radius: 5px; cursor: pointer; }
    .stock-left { font-size: 0.85em; margin-top: 5px; color: #ccc; }
    .total-bar { margin-top: 20px; font-size: 20px; text-align: right; font-weight: bold; }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 8px; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
    .notification.show { opacity: 1; }
    @media(max-width: 768px) { .top-bar { flex-direction: column; align-items: stretch; } .buttons { flex-direction: column; } }
  </style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by name or code..." autocomplete="off" />
      <div class="suggestions" id="suggestions"></div>
    </div>
    <a href="#" class="btn logout-btn" onclick="logout()">LOG OUT</a>
  </div>

  <div class="product-list" id="cartSection"></div>

  <div class="total-bar" id="totalAmount">Total: Rs. 0</div>

  <div class="buttons">
    <a href="settings.html" class="btn black-btn">SETTINGS</a>
    <a href="#" class="btn green-btn" id="checkoutBtn">CHECK OUT</a>
  </div>
</div>
<div id="notification" class="notification"></div>

<script>
  const notificationEl = document.getElementById("notification");
  function showNotification(message, duration = 3000) { notificationEl.textContent = message; notificationEl.classList.add("show"); setTimeout(() => notificationEl.classList.remove("show"), duration); }

  // Attempt to persist storage for EXE environments
  (async () => {
    if (navigator.storage && navigator.storage.persist) {
      try { await navigator.storage.persist(); } catch(e){}
    }
  })();

  let allProducts = [];
  // Bug fix: Only load default products if 'products' key is not explicitly set in localStorage
  // This allows for an empty product list if desired.
  if (localStorage.getItem("products") === null) {
    allProducts = [
      { code: "m001", name: "Milk", price: 50, stock: 10 },
      { code: "m002", name: "Mango Juice", price: 120, stock: 15 },
      { code: "s001", name: "Sugar", price: 70, stock: 25 },
      { code: "c001", name: "Cookies", price: 150, stock: 18 },
      { code: "b001", name: "Bread", price: 40, stock: 20 },
      { code: "t001", name: "Tea", price: 90, stock: 22 },
      { code: "o001", name: "Oil", price: 180, stock: 12 }
    ];
    localStorage.setItem("products", JSON.stringify(allProducts));
  } else {
    try {
      allProducts = JSON.parse(localStorage.getItem("products")) || [];
    } catch(e){
      console.error("Error parsing products from localStorage:", e);
      allProducts = []; // Fallback to empty array if parsing fails
    }
  }

  const cart = JSON.parse(localStorage.getItem("cartData")) || {};

  const searchInput = document.getElementById("searchInput");
  const suggestionsBox = document.getElementById("suggestions");
  const cartSection = document.getElementById("cartSection");
  const totalAmount = document.getElementById("totalAmount");
  const checkoutBtn = document.getElementById("checkoutBtn");

  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    suggestionsBox.innerHTML = "";
    if (query.length > 0) {
      const matched = allProducts.filter(p => p.name.toLowerCase().includes(query) || p.code.toLowerCase().includes(query));
      matched.forEach(product => {
        const stock = product.stock || 0;
        const div = document.createElement("div");
        div.textContent = `${product.name} (${product.code}) - Rs. ${product.price} - Stock: ${stock}`;
        div.onclick = () => { addToCart(product); searchInput.value = ""; suggestionsBox.innerHTML = ""; };
        suggestionsBox.appendChild(div);
      });
    }
  });

  function addToCart(product) {
    const stockAvailable = product.stock || 0;
    const currentQty = cart[product.code]?.qty || 0;
    if (currentQty < stockAvailable) {
      if (!cart[product.code]) { cart[product.code] = { ...product, qty: 1 }; } else { cart[product.code].qty += 1; }
      showNotification(`${product.name} added to cart.`, 1500);
    } else { showNotification(`Cannot add more. Only ${stockAvailable} in stock.`, 3000); }
    saveCart(); renderCart();
  }

  function renderCart() {
    cartSection.innerHTML = "";
    let total = 0;
    Object.values(cart).forEach(item => {
      // Re-fetch product data to get the most current stock
      const currentProductInStock = allProducts.find(p => p.code === item.code);
      const stockAvailable = currentProductInStock?.stock || 0;
      // This correctly shows stock remaining if this item is purchased from the current stock
      const stockLeft = stockAvailable - item.qty;
      const div = document.createElement("div");
      div.className = "product-item";
      div.innerHTML = `
        <div class="top-row">
          <div class="product-name">${item.name}</div>
          <div>Rs. ${(item.price * item.qty).toFixed(2)}</div>
        </div>
        <div class="qty-controls">
          <button onclick="updateQty('${item.code}', -1)">-</button>
          <span>${item.qty}</span>
          <button onclick="updateQty('${item.code}', 1)">+</button>
        </div>
        <div class="stock-left">Stock left: ${stockLeft}</div>
      `;
      cartSection.appendChild(div);
      total += item.price * item.qty;
    });
    totalAmount.textContent = `Total: Rs. ${total.toFixed(2)}`;
  }

  function updateQty(code, delta) {
    if (cart[code]) {
      const product = allProducts.find(p => p.code === code);
      const stockAvailable = product?.stock || 0;
      const newQty = cart[code].qty + delta;
      if (newQty > stockAvailable) { showNotification(`Cannot increase quantity. Only ${stockAvailable} in stock.`, 3000); return; }
      if (newQty <= 0) {
        if (confirm(`Remove ${cart[code].name} from the cart?`)) { delete cart[code]; showNotification(`${product.name} removed.`, 1500); } else { return; }
      } else { cart[code].qty = newQty; showNotification(`Quantity of ${product.name} updated.`, 1500); }
      saveCart(); renderCart();
    }
  }

  function logout() { window.location.href = "index.html"; }
  function saveCart() { localStorage.setItem("cartData", JSON.stringify(cart)); }

  checkoutBtn.addEventListener("click", () => {
    if (Object.keys(cart).length === 0) { showNotification("Cart is empty! Add products before checkout.", 3000); return; }
    saveCart(); window.location.href = "checkout.html";
  });

  document.addEventListener("keydown", (e) => { if (e.key === "Enter") { checkoutBtn.click(); } });
  window.addEventListener("load", renderCart);
</script>
</body>
</html>
